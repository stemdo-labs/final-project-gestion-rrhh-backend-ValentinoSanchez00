pipeline {
    agent {
        kubernetes {
            label 'jenkins-jenkins-agent'
            defaultContainer 'jnlp'
        }
    }  
    environment {
        APIKEY = credentials('IBM_CLOUD_API_KEY_VSANCHEZ') 
        MICROSERVICE = 'backend'
    }
    parameters {
        string(name: 'ENVIRONMENT', defaultValue: 'develop', description: 'Ambiente de despliegue (develop/production)')
    }
    stages {
        stage('Mostrar Configuración') {
            steps {
                echo "Configuración elegida:"
                echo "Microservicio: ${MICROSERVICE}"
                echo "Ambiente: ${params.ENVIRONMENT}"
            }
        }
        stage('Test Frontend') {
            when {
                allOf {
                    expression { MICROSERVICE == 'frontend' }
                    expression { params.ENVIRONMENT == 'production' }
                }
            }
            steps {
                echo "Configurando y ejecutando linte"
                sh """
                npm install eslint --save-dev
                npx eslint --init
                npx eslint . --ext .js,.jsx,.ts,.tsx
                """
            }
        }
        stage('Configurar default.conf') {
            when {
                expression { params.MICROSERVICE == 'frontend' }
            }
            steps {
                script {
                    def confPath = "default.conf"
                    def backendUrl = params.ENVIRONMENT == 'develop' 
                        ? "http://backend-develop-svc:8080" 
                        : "http://backend-production-svc:8080"
                    def location = params.ENVIRONMENT == 'develop' 
                        ? "/dev-vsanchez" 
                        : "/prod-vsanchez"
                    sh """
                    sed -i "s|proxy_pass http://svc-backend:8080;|proxy_pass ${backendUrl};|g" ${confPath}
                    sed -i "s|location /pepe-vsanchez |location ${location} |g" ${confPath}
                    """
                    sh "cat ${confPath}"
                }
            }
        }
        stage('Instalar Docker') {
            steps {
                script {
                    sh '''
                        whoami
                        apt-get update
                        apt-get install -y ca-certificates curl
                        install -m 0755 -d /etc/apt/keyrings
                        curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
                        chmod a+r /etc/apt/keyrings/docker.asc
 
                        echo \
                            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
                            $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                            tee /etc/apt/sources.list.d/docker.list > /dev/null
                        apt-get update
 
                        apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                    '''
                }
            }
        }
        stage('Instalar Herramientas') {
            steps {
                sh """
                curl -sL https://aka.ms/InstallAzureCLIDeb | bash
                curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
                ibmcloud plugin install container-registry -r 'IBM Cloud'
                ibmcloud plugin install container-service -r 'IBM Cloud'
                apt-get install -y libxml2-utils
                apt update && apt upgrade -y
                dockerd > /var/log/dockerd.log 2>&1 & sleep 10 
                """
            }
        }
        stage('Login IBM Cloud') {
            steps {
                sh """
                ibmcloud login --apikey ${APIKEY} -r eu-gb
                ibmcloud target -g Stemdo_Sandbox
                ibmcloud cr login
                ibmcloud cr namespace-add cr-vsanchez
                """
            }
        }

        stage('Extraer Versión') {
            steps {
                script {
                    // Mostrar los archivos del directorio actual y verificar pom.xml
                    sh 'ls -l'
                    sh 'cat pom.xml | head -n 20'

                    // Determinar la versión dependiendo del microservicio
                    if (params.MICROSERVICE == 'frontend') {
                        // Extraer versión del archivo package.json para frontend
                        env.VERSION = sh(
                            script: "node -pe 'require(\"./package.json\").version'",
                            returnStdout: true
                        ).trim()
                    } else if (params.MICROSERVICE == 'backend') {
                        // Extraer versión del archivo pom.xml para backend
                        echo " extrayendo versión del archivo pom.xml"
                        env.VERSION = sh(
                            script: """
                            awk '/<artifactId>rh<\\/artifactId>/,/<\\/project>/{
                                if (\$0 ~ /<version>/) {
                                    print \$0
                                }
                            }' pom.xml | sed -n '1p' | sed -E 's/.*<version>(.*)<\\/version>.*/\\1/'
                            """,
                            returnStdout: true
                        ).trim()
                    }

                    // Imprimir la versión detectada
                    echo "Versión detectada: ${env.VERSION}"
                }
            }
        }
        stage('Construir Imagen') {
            steps {
                sh "docker build -t imagen-proyecto-${params.MICROSERVICE}-${params.ENVIRONMENT} ."
            }
        }
        stage('Taggear Imagen') {
            steps {
                sh """
                docker tag imagen-proyecto-${params.MICROSERVICE}-${params.ENVIRONMENT} uk.icr.io/cr-vsanchez/imagen-proyecto-${params.MICROSERVICE}-${params.ENVIRONMENT}:${env.VERSION}
                """
            }
        }
        stage('Pushear Imagen') {
            steps {
                sh """
                docker push uk.icr.io/cr-vsanchez/imagen-proyecto-${params.MICROSERVICE}-${params.ENVIRONMENT}:${env.VERSION}
                """
            }
        }
    }
}
